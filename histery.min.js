/*!
 * Histery.js v0.5.2, https://github.com/hoho/histery
 * (c) 2013 Marat Abdullin, MIT license
 */
!function(a,b,c){var d,e,f,g,h,i,j,k=a.history||{},l=[],m=0,n=[],o=[],p=[],q=[],r=[],s=0,t={}.constructor,u=function(a){return"function"==typeof a},v=function(a){return a&&a.constructor===t},w=function(a,c){return c=b,a&&(c=document.createElement("a"),c.href=a),c=c.pathname+c.search+(c.hash.length>1?c.hash:""),"/"===c[0]?c:"/"+c},x=function(a,b,c,d,e){return b instanceof RegExp?(c=0,d=a.replace(b,function(){return c++,e=Array.prototype.slice.call(e=arguments,1,e.length-2),""})):u(b)?(c=1,e=b(a),!e||e instanceof Array||(e=[e])):a===b&&(c=1,e=[]),1!==c||d?void 0:e},y=function(a,b,c,d,e){return a.replace(/^([^?#]+)(?:\?([^#]*))?(?:#(.*))?$/,function(a,b,f,g){c=b||"",d=f||"",e=g||""}),c&&(v(b)?(c=b.pathname?x(c,b.pathname):[],d=b.search?x(d,b.search):[],e=b.hash?x(e,b.hash):[]):(c=x(c,b),d=e=[]),c&&d&&e)?[a].concat(c,d,e):void 0},z=function(a,b,c,d,e){for(d=0;d<b.length;d++)e=b[d],e[0]===a&&c.push(e[1])},A=function(a,b){for(;b=a.shift();)b()},B=function(){A(p),A(q),n=[],o=[]},C=function(a){return h=0,a?(A(o),n=[]):(A(n),o=[]),A(q),p=[],d};a.$H=d={run:function(){return $(a).on("popstate hashchange",function(){i&&i===b.href||(j&&a.clearTimeout(j),i=b.href,g=!0,d.go(),j=a.setTimeout(function(){j=c,i=c},500))}).trigger("popstate"),d},stop:function(){return C()},go:function(a){var i,j,t,v=[],x=!1,D={},E=[],F=[],G=[],H=[],I=[],J=[],K=0;for(C(),a=w(a),s++,j=0;j<l.length;j++)e=l[j],(!e.h||(t=y(a,e.h)))&&(e.h?D[j]=x=!0:t=[a],function(a,b,d){a.unshift(e.cur);var f=e,g=!!e.h,i=a.slice(0);i.unshift(c),u(b)&&(b=b()),function(b){var e=function(c,e){e&&c.push([g,function(){d===s&&e.apply(b,a)}])};b.go?(g?h++:K++,function(){var e;E.push([g,function(){e=b.go.apply(b,a),e&&e.promise&&e.then?e.then(function(a){d===s&&(e=a,0===--h&&B())},function(){d===s&&C(!0)}):e||e===c?0===--h&&B():C(!0)}]),b.success&&H.push([g,function(){d===s&&(i[0]=e,b.success.apply(b,i))}])}()):b.success&&H.push([g,function(){d===s&&(i[0]=c,b.success.apply(b,i))}]),e(F,b.stop),e(G,b.error),e(I,b.complete),b.leave&&J.push([g,function(){a[0]=f.cur,b.leave.apply(b,a)}])}(b)}(t,e.c,s));for(z(x,E,v),z(x,F,n),z(x,G,o),z(x,H,p),z(x,I,q),i=0;i<l.length;i++)e=l[i],e.cur=x&&D[i]||!x&&!e.h;return A(r),z(x,J,r),f&&(k.pushState?g||k.pushState(null,null,a):b.href=a),f=!0,g=!1,(x||m)&&(x||(h=K),h?A(v):B()),d},on:function(a,b){return l.push({h:a,c:b,cur:!1}),a||m++,d},off:function(a,b){a||b||(l=[]);for(var c,e=l.length-1;e>=0;)c=l[e],c.h!==a||b&&c.c!==b||(l.splice(e,1),c.h||m--),e--;return d}}}(window,location);