/*!
 * Histery.js v0.1.4, https://github.com/hoho/histery
 * (c) 2013 Marat Abdullin, MIT license
 */
!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=a.history||{},o={},p=[],q=[],r=[],s=[],t=[],u=0,v=[],w=function(a){return a instanceof RegExp},x=function(a){return a&&($.isPlainObject(a)?"m"+a.pathname+"|"+a.search+"|"+a.hash:(w(a)?"e":"s")+a)},y=function(a,c){return c=b,a&&(c=document.createElement("a"),c.href=a),c=c.pathname+c.search+(c.hash.length>1?c.hash:""),"/"===c[0]?c:"/"+c},z=function(a,b,c,d,e){return w(b)?(c=0,d=a.replace(b,function(){return c++,e=Array.prototype.slice.call(e=arguments,1,e.length-2),""})):a===b&&(c=1,e=[]),1!==c||d?void 0:e},A=function(a,b,c,d,e,f){return b.replace(/^([^?#]+)(?:\?([^#]*))?(?:#(.*))?$/,function(a,b,c,g){d=b,e=c,f=g}),d&&(a?(d=z(d,c.pathname),e=c.search&&e?z(e,c.search):[],f=c.hash&&f?z(f,c.hash):[]):(d=z(d,c),e=f=[]),d&&e&&f)?[b].concat(d,e,f):void 0},B=function(a,b,c){for(c=0;c<a.length;)a[c]===b?a.splice(c,1):c++},C=function(a,b){for(;b=a.shift();)b()},D=function(){C(r),C(s),p=[],q=[]},E=function(a){return k=0,a?(C(q),p=[]):(C(p),q=[]),C(s),r=[],d};a.$H=d={run:function(){return $(a).on("popstate hashchange",function(){l&&l===b.href||(m&&a.clearTimeout(m),l=b.href,j=!0,d.go(),m=a.setTimeout(function(){m=c,l=c},500))}).trigger("popstate"),d},stop:function(){return E()},go:function(a){var f,l,m,w;E(),C(t),a=y(a),e=[],u++;for(m in o)g=o[m],(w=A("m"===m[0],a,g.h))&&(f=!0,function(a,b,d){var f=a.slice(0);for(a.unshift(c),l=0;l<b.length;l++)$.isFunction(h=b[l])&&(h=h()),function(b){var g=function(a,c){c&&a.push(function(){d===u&&c.apply(b,f)})};b.go?(k++,function(){var c;e.push(function(){c=b.go.apply(b,f),c&&c.promise&&c.then?c.then(function(a){d===u&&(c=a,0===--k&&D())},function(){d===u&&E(!0)}):c?0===--k&&D():E(!0)}),b.success&&r.push(function(){d===u&&(a[0]=c,b.success.apply(b,a))})}()):b.success&&r.push(function(){d===u&&(a[0]=c,b.success.apply(b,a))}),g(p,b.stop),g(q,b.error),g(s,b.complete),g(t,b.leave)}(h)}(w,g.c,u));if(i&&(n.pushState?j||n.pushState(null,null,a):b.href=a),i=!0,j=!1,!f){for(l=0;l<v.length;l++)v[l](a);return d}return k?C(e):D(),d},on:function(a,b){return(g=o[f=x(a)])?g.c.push(b):f&&(o[f]={h:a,c:[b]}),d},off:function(a,b){if(a||(o={}),g=o[f=x(a)]){if(b&&(g=g.c,B(g,b),g.length))return d;delete o[f]}return d},noMatch:function(a,b){return b?B(v,a):v.push(a),d}}}(window,location);