/*!
 * Histery.js v0.5.0, https://github.com/hoho/histery
 * (c) 2013 Marat Abdullin, MIT license
 */
!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=a.history||{},o={},p=[],q=[],r=[],s=[],t=[],u=0,v={},w="no",x=function(a){return a instanceof RegExp},y=function(a){return a&&($.isPlainObject(a)?"m"+a.pathname+"|"+a.search+"|"+a.hash:(x(a)?"e":"s")+a)||w},z=function(a,c){return c=b,a&&(c=document.createElement("a"),c.href=a),c=c.pathname+c.search+(c.hash.length>1?c.hash:""),"/"===c[0]?c:"/"+c},A=function(a,b,c,d,e){return x(b)?(c=0,d=a.replace(b,function(){return c++,e=Array.prototype.slice.call(e=arguments,1,e.length-2),""})):a===b&&(c=1,e=[]),1!==c||d?void 0:e},B=function(a,b,c,d,e,f){return b.replace(/^([^?#]+)(?:\?([^#]*))?(?:#(.*))?$/,function(a,b,c,g){d=b,e=c,f=g}),d&&(a?(d=A(d,c.pathname),e=c.search&&e?A(e,c.search):[],f=c.hash&&f?A(f,c.hash):[]):(d=A(d,c),e=f=[]),d&&e&&f)?[b].concat(d,e,f):void 0},C=function(a,b,c){for(c=0;c<a.length;)a[c]===b?a.splice(c,1):c++},D=function(a,b){for(;b=a.shift();)m!==b[0]&&b[1]()},E=function(){D(r),D(s),p=[],q=[]},F=function(a){return j=0,a?(D(q),p=[]):(D(p),q=[]),D(s),r=[],d};a.$H=d={run:function(){return $(a).on("popstate hashchange",function(){k&&k===b.href||(l&&a.clearTimeout(l),k=b.href,i=!0,d.go(),l=a.setTimeout(function(){l=c,k=c},500))}).trigger("popstate"),d},stop:function(){return F()},go:function(a){var e,k,l,x=[],y={},A={},C=[],G=[],H=m,I=0;F(),m=!1,a=z(a),u++;for(k in o)f=o[k],(k===w||(l=B("m"===k[0],a,f.h)))&&(k===w?(l=[a],A[k]=!0):y[k]=m=!0,function(a,b,d){a.unshift(k in v);var f=k,h=f===w,i=a.slice(0);for(i.unshift(c),e=0;e<b.length;e++)$.isFunction(g=b[e])&&(g=g()),function(b){var e=function(c,e){e&&c.push([h,function(){d===u&&e.apply(b,a)}])};b.go?(h?I++:j++,function(){var e;x.push([h,function(){e=b.go.apply(b,a),e&&e.promise&&e.then?e.then(function(a){d===u&&(e=a,0===--j&&E())},function(){d===u&&F(!0)}):e||e===c?0===--j&&E():F(!0)}]),b.success&&r.push([h,function(){d===u&&(i[0]=e,b.success.apply(b,i))}])}()):b.success&&r.push([h,function(){d===u&&(i[0]=c,b.success.apply(b,i))}]),e(p,b.stop),e(q,b.error),e(s,b.complete),b.leave&&(h?G:C).push([h,function(){a[0]=f in v,b.leave.apply(b,a)}])}(g)}(l,f.c,u));return v=m?y:A,e=m,m=H,D(t),m=e,t=m?C:G,h&&(n.pushState?i||n.pushState(null,null,a):b.href=a),h=!0,i=!1,(m||A[w])&&(m||(j=I),j?D(x):E()),d},on:function(a,b){return(f=o[e=y(a)])?f.c.push(b):e&&(o[e]={h:a,c:[b]}),d},off:function(a,b){if(a||(o={}),f=o[e=y(a)]){if(b&&(f=f.c,C(f,b),f.length))return d;delete o[e]}return d}}}(window,location);